##Habilitar la reescritura 
RewriteEngine On

RewriteRule ^sitemap\.xml/?$ sitemap.php

# ============================================
# FORZAR HTTPS (OBLIGATORIO PARA SEGURIDAD)
# ============================================
# Redirige todo el tráfico HTTP a HTTPS con código 301 (permanente)
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]

## Esconder extension .php 

# Redirigir /farmacialosllanos/archivo.php a /farmacialosllanos/archivo
RewriteCond %{THE_REQUEST} ^[A-Z]{3,}\s([^.]+)\.php [NC]
RewriteRule ^ %1 [R,L]

# Reenviar internamente /farmacialosllanos/archivo a /farmacialosllanos/archivo.php
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^(.*?)/?$ $1.php [L]

ErrorDocument 404 /farmacialosllanos/404
ErrorDocument 403 /farmacialosllanos/403
ErrorDocument 500 /farmacialosllanos/500

# START - Disable server signature #
ServerSignature Off
# END - Disable server signature #
# ============================================
# CABECERAS DE SEGURIDAD HTTP
# ============================================

<IfModule mod_headers.c>
    # Strict-Transport-Security (HSTS)
    # Fuerza HTTPS durante 1 año (31536000 segundos)
    # includeSubDomains: aplica a todos los subdominios
    # preload: permite incluir el sitio en la lista de precarga HSTS de navegadores
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" env=HTTPS
    
    # X-Frame-Options
    # Previene ataques de clickjacking bloqueando que el sitio se cargue en iframes
    # SAMEORIGIN: permite iframes solo del mismo origen
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # X-Content-Type-Options
    # Previene MIME-sniffing, forzando al navegador a respetar el Content-Type declarado
    Header always set X-Content-Type-Options "nosniff"
    
    # X-XSS-Protection
    # Activa el filtro XSS integrado del navegador
    # mode=block: bloquea la página completamente si detecta XSS
    Header always set X-XSS-Protection "1; mode=block"
    
    # Referrer-Policy
    # Controla qué información de referrer se envía
    # strict-origin-when-cross-origin: envía origen completo solo en mismo origen
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Permissions-Policy (anteriormente Feature-Policy)
    # Controla qué características del navegador puede usar el sitio
    Header always set Permissions-Policy "camera=(), microphone=(), geolocation=(self), payment=()"
    
    # Content-Security-Policy (CSP)
    # Política de seguridad de contenido - previene XSS y ataques de inyección
    # Esta es una configuración permisiva inicial - ajustar según necesidades
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://ajax.googleapis.com https://www.google.com https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https:; connect-src 'self'; frame-src 'self' https://www.google.com; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'self';"
    
    # X-Permitted-Cross-Domain-Policies
    # Controla si otros dominios pueden cargar datos desde este sitio
    Header always set X-Permitted-Cross-Domain-Policies "none"
    
    # Eliminar cabeceras que revelan información del servidor
    Header always unset X-Powered-By
    Header unset X-Powered-By
    Header always unset Server
    Header unset Server
</IfModule>

# ============================================
# PROTECCIÓN ADICIONAL
# ============================================

# Deshabilitar la visualización de directorios
Options -Indexes

# Proteger archivos sensibles
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

# Proteger archivos de configuración
<FilesMatch "(composer\.json|composer\.lock|package\.json|\.env|\.htaccess|\.htpasswd)$">
    Order allow,deny
    Deny from all
</FilesMatch>